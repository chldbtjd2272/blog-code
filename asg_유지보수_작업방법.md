ASG에 속한 특정 ec2 인스턴스에 유지관리 작업을 수행하려한다. 유지보수패치를 할때 인스턴스 상태 점검 상태가 몇분동안 서비스 중이 아닌것으로 표시된다. 이로 인해 다른 인스턴스로 프로비저닝된다. 최대한 빨리 유지보수작업을 할 수 있는방법은?



- 인스턴스를 대기 상태로 전환한 다음 유지관리패치를 적용하여 인스턴스를 업데이트한다. 인스턴스가 준비되면 대기상태를 종료한 다음 서비스 상태로 되돌릴 수 있다

  - 대기 상태인 인스턴스의 상태

    Amazon EC2 Auto Scaling 은 대기 상태의 인스턴스에 대한 상태 확인을 수행하지 않습니다. 인스턴스가 대기 상태에 있는 동안 이 인스턴스의 상태는 대기 상태로 설정되기 전의 상태를 반영합니다. Amazon EC2 Auto Scaling 은 인스턴스를 서비스 상태로 설정할 때까지 해당 인스턴스에 대한 상태 확인을 수행하지 않습니다.

  - 대기 상태의 작동 방식

    - 인스턴스를 대기 상태로 설정합니다. 인스턴스는 대기 상태를 끝낼 때까지 이 상태로 유지됩니다.
    - Auto Scaling 그룹에 연결된 로드 밸런서 대상 그룹 또는 클래식 로드 밸런서가 있는 경우, 로드 밸런서에서 해당 인스턴스가 등록 취소됩니다. 로드 밸런서에서 연결 드레이닝이 활성화된 경우 Elastic Load Balancing ing은 기본적으로 300초 동안 대기하는데, 이는 진행 중인 요청을 완료하는 데 도움이 됩니다.
    - 기본적으로 인스턴스를 대기 상태로 설정하면 희망 용량으로 지정한 값은 감소합니다. 그러면 이 인스턴스가 대기 상태에 있는 동안 추가 인스턴스를 시작하지 않도록 합니다. 또는 용량이 감소되지 않도록 지정할 수 있습니다. 이 옵션을 지정하는 경우 Auto Scaling 그룹에서 인스턴스를 시작하여 대기 상태의 인스턴스를 교체합니다. 하나 이상의 인스턴스가 대기 상태에 있는 동안 애플리케이션의 용량을 유지하기 위해서 입니다.
    - 인스턴스를 업데이트하거나 문제를 해결할 수 있습니다.
    - 대기 상태를 끝내 인스턴스를 서비스 상태로 되돌립니다.
    - 대기 상태였던 인스턴스를 다시 서비스 상태로 설정한 이후 원하는 용량이 증가합니다. 인스턴스를 대기 상태로 설정할 때 용량을 줄이지 않은 경우 Auto Scaling 그룹은 필요 이상의 인스턴스가 있음을 감지합니다. 그런 다음 종료 정책을 적용하여 그룹의 크기를 줄입니다. 
    - Auto Scaling 그룹에 연결된 로드 밸런서 대상 그룹 또는 클래식 로드 밸런서가 있는 경우, 해당 인스턴스가 로드 밸런서에 등록됩니다.



- asg에 대한 시작 프로세스 유형을 일시 중단하고 인스턴스에 유지 관리 패치를 적용한다. 인스턴스가 준비완료되면 시작 프로세스 유형을 다시 활성화한다.
  - 종료 프로세스 유형
    - Auto Scaling 그룹은 이 프로세스가 일시 중지된 동안 발생한 경보나 예약된 작업에 따라 축소되지 않습니다. 이와 함께 다음 프로세스가 중단됩니다.
    - `AZRebalance`는 여전히 활성이지만 정상적으로 작동하지 않습니다. 오래된 인스턴스를 종료하지 않고도 새 인스턴스를 시작할 수 있습니다. 이로 인해 Auto Scaling 그룹이 최대 크기보다 최대 10% 더 크게 확장될 수 있습니다. 재분배 활동 시 이를 일시적으로 허용하기 때문입니다. Auto Scaling 그룹은 최대 크기 이상으로 유지될 수 있습니다.`Terminate`프로세스입니다. 일시`Terminate`Resume`AZRebalance`가용 영역 간에 그룹의 균형이 더 이상 유지되지 않거나 다른 가용 영역이 지정된 경우, 가 서서히 Auto Scaling 그룹을 재분배합니다.
    - `ReplaceUnhealthy`는 비활성 상태이지만 `HealthCheck`는 아닙니다. `Terminate`가 재개되면 `ReplaceUnhealthy` 프로세스는 즉시 실행되기 시작합니다. `Terminate`가 일시 중지된 동안 비정상으로 표시되었던 인스턴스는 즉시 교체됩니다.
    - `InstanceRefresh`는 다시 시작할 때까지 일시 중지됩니다.`Terminate`.
    - 요약 정보 - **terminate를 중지하면 비정상 인스턴스를 종료하지 않고, AzRebalance를 수행한다. 가용영역 하나가 비정상적이다가 정상으로 돌아오면 인스턴스 수를 rebalance하는데 기존 운영 인스턴스를 종료하지 않고 추가 가용영역에 인스턴스를 추가한다**
  - 시작 프로세스 유형
    - Auto Scaling 그룹은 이 프로세스가 일시 중지된 동안 발생한 경보나 예약된 작업에 따라 축소되지 않습니다.`AZRebalance`는 그룹 재조정을 중지합니다.`ReplaceUnhealthy`는 비정상 인스턴스를 계속 종료하지만 교체를 실행하지는 않습니다. 
    - 요약 정보 - **비정상 인스턴스를 종료하지 않는다. 인스턴스 수를 늘리지 않는다.**



참고

-  https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/as-enter-exit-standby.html
-  https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/as-suspend-resume-processes.html
-  https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-suspend-resume-processes.html













다음 그림에서는 이 프로세스에서 인스턴스 상태 간 전환을 보여 줍니다.

- 